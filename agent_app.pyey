import time
import streamlit as st
import random

# ----------------------------------
# Streamlit Page Config
# ----------------------------------
st.set_page_config(page_title="Agentic AI Loan System", layout="wide")
st.title("ðŸ¤– Agentic AI Personal Loan Automation â€“ LIVE Agent Prototype")
st.caption("FinNova | EY Techathon 6.0")

# ----------------------------------
# Input Fields
# ----------------------------------
st.sidebar.header("Applicant Details")

name = st.sidebar.text_input("Applicant Name", "Rahul Sharma")
loan_amount = st.sidebar.number_input("Loan Amount (â‚¹)", 50000, 2000000, 300000, 50000)
income = st.sidebar.number_input("Monthly Income (â‚¹)", 10000, 300000, 60000, 5000)
emi = st.sidebar.number_input("Existing EMI (â‚¹)", 0, 200000, 5000, 1000)
credit_score = st.sidebar.slider("Credit Score", 550, 900, 760)
tenure = st.sidebar.slider("Tenure (years)", 1, 7, 3)
employment = st.sidebar.selectbox("Employment Type", ["Salaried", "Self-Employed"])

start_button = st.sidebar.button("â–¶ Run Agents")

# ----------------------------------
# Container Setup
# ----------------------------------
agent_log = st.empty()
decision_box = st.empty()
explain_box = st.empty()
letter_box = st.empty()

# ----------------------------------
# Helper functions
# ----------------------------------
def log(msg):
    agent_log.write(msg)
    time.sleep(0.6)

def calculate_decision():
    rate = 0.12
    if credit_score >= 780:
        rate = 0.115
        risk = "LOW RISK"
    elif credit_score >= 720:
        rate = 0.125
        risk = "MEDIUM RISK"
    else:
        rate = 0.145
        risk = "HIGH RISK"

    months = tenure * 12
    emi_calc = (loan_amount * (1 + rate * tenure)) / months
    dti = (emi + emi_calc) / income

    if credit_score >= 720 and dti <= 0.5:
        decision = "APPROVED"
    elif credit_score >= 650 and dti <= 0.65:
        decision = "COUNTER OFFER"
    else:
        decision = "REJECTED"

    return decision, rate, emi_calc, risk, dti, months

def explain_factors():
    return {
        "Income Stability": round((income - 25000) / 30000, 2),
        "Credit Score Strength": round((credit_score - 700) / 150, 2),
        "Existing Obligations": round(-(emi / income) * 2, 2),
        "Policy Adjustments": round(random.uniform(-0.2, 0.2), 2)
    }

# ----------------------------------
# Run Agent Workflow
# ----------------------------------
if start_button:
    log("ðŸ§  **MASTER AGENT:** Starting full loan journey...\n")

    log(f"ðŸ—£ï¸ **SALES AGENT:** User requested â‚¹{loan_amount:,} for {tenure} years.")
    log("ðŸ—£ï¸ **SALES AGENT:** Collecting user details...")

    log("\nðŸ”Ž **VERIFICATION AGENT:** Verifying identity & employment...")
    log(f"ðŸ”Ž Monthly income: â‚¹{income:,}")
    log(f"ðŸ”Ž Existing EMI: â‚¹{emi:,}")
    log(f"ðŸ”Ž Employment: {employment} âœ”")

    log("\nðŸ“Š **CREDIT AGENT:** Fetching credit bureau score...")
    log(f"ðŸ“Š Credit Score: {credit_score} âœ”")

    log("\nâš–ï¸ **RISK AGENT:** Evaluating profile...")
    decision, rate, emi_calc, risk_band, dti, months = calculate_decision()
    log(f"âš–ï¸ Risk Band: {risk_band}")
    log(f"âš–ï¸ Debt-to-Income Ratio: {round(dti, 2)}")

    log("\nðŸ§© **EXPLAINABILITY AGENT:** Creating reason codes...")
    factors = explain_factors()
    for k, v in factors.items():
        log(f"- {k}: {v}")

    log("\nðŸ **DECISION AGENT:** Finalizing decision...")

    # Show decision box
    if decision == "APPROVED":
        decision_box.success(f"ðŸŽ‰ APPROVED â€“ â‚¹{loan_amount:,} @ {round(rate*100,2)}% interest")
    elif decision == "COUNTER OFFER":
        decision_box.warning(f"âš  Counter Offer â€“ Lower amount recommended")
    else:
        decision_box.error("âŒ REJECTED â€“ Does not meet risk criteria")

    # Explainability
    explain_box.subheader("ðŸ“Š Explainability Factors")
    explain_box.json(factors)

    # Sanction letter
    if decision in ["APPROVED", "COUNTER OFFER"]:
        letter_box.info(
f"""
### ðŸ“ Sample Sanction Letter  
**Applicant:** {name}  
**Decision:** {decision}  
**Sanctioned Amount:** â‚¹{loan_amount:,}  
**Interest Rate:** {round(rate*100,2)}%  
**Tenure:** {months} months  
**Approx EMI:** â‚¹{int(emi_calc):,}  
"""
        )
    else:
        letter_box.warning("No sanction letter generated for rejected applications.")
